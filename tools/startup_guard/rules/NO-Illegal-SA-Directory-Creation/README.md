# NO-Illegal-SA-Directory-Creation 规则说明

## 规则解释

  - 规则要求
    1. **目录位置限制**：仅对`/data`目录下的mkdir命令进行校验，非`/data`目录下的mkdir命令默认通过校验
    2. **允许路径**：在`/data`目录下，仅允许在`/data/service`、`/data/app`和`/data/chipset`目录及其子目录下创建目录
    3. **路径内容限制**：路径中不允许出现目录名称为"100"、"101"、"102"、"103"、"104"或"105"的目录，除非满足以下条件：
       - 完整的数字目录路径（包含该数字目录本身）在白名单中
       - 如果完整的数字目录路径在白名单中，其下级子目录也被允许
    4. **白名单机制**：
       - 对于不包含100-105目录的路径，支持前缀匹配（如白名单包含"/data/bluetooth"，则"/data/bluetooth/log"合法）
       - 对于包含100-105目录的路径，仅当完整的数字目录路径（截止到该数字目录）在白名单中时才允许（如白名单包含"/data/abc/100"，则"/data/abc/100"和"/data/abc/100/test"合法，但"/data/abc/100/101"需检查"101"目录是否在白名单中）

    检查流程按以下步骤执行：
    1. 检查路径是否是`/data`目录下的子目录（非`/data`目录默认通过）
    2. 检查路径是否为`/data`目录本身（是则通过）
    3. 检查路径是否在允许的基础目录（`/data/service`、`/data/app`、`/data/chipset`）下
    4. 检查路径中是否包含目录名称为"100"、"101"、"102"、"103"、"104"或"105"的目录
    5. 根据路径是否包含上述数字目录，采用不同的白名单匹配策略：
       - 若包含数字目录：将路径截断到第一个数字目录，检查该截断路径是否在白名单中
       - 若不包含数字目录：检查路径是否与白名单中的路径前缀匹配
    6. 如果以上条件都不满足，检查失败

  - 白名单机制
    白名单是纯路径字符串数组，根据路径是否包含100-105目录采用不同的匹配策略：

    1. **不包含100-105目录的路径**：支持前缀匹配
       - 示例：如果白名单包含"/data/bluetooth"，则"/data/bluetooth/log"等子目录也会被视为合法

    2. **包含100-105目录的路径**：仅支持完整路径匹配（截止到第一个数字目录）
       - 示例1：如果白名单包含"/data/100"，则"/data/100"和"/data/100/test"合法
       - 示例2：如果白名单仅包含"/data/abc"，则"/data/abc/100"非法
       - 示例3：如果白名单包含"/data/abc/100"，则"/data/abc/100"和"/data/abc/100/test"合法

    白名单配置示例：
    ```json
    [
        "/data/bluetooth",        // 允许"/data/bluetooth"及其所有非数字子目录
        "/data/usb",             // 允许"/data/usb"及其所有非数字子目录
        "/data/100",             // 允许"/data/100"及其所有子目录
        "/data/service/el1/101"   // 允许"/data/service/el1/101"及其所有子目录
    ]
    ```

  - 检查范围
    检查所有SA的cfg配置文件中使用mkdir命令创建目录的行为。

编译时会提示如下类型的告警：
  ```
  [NOT ALLOWED]: mkdir directory must be a subdirectory of ["/data/service", "/data/app", "/data/chipset"] or be in whitelist: /data/xxx 0755 xxx xxx in file xxx.cfg
  [NOT ALLOWED]: mkdir directory path contains illegal directory name '100': /data/service/xxx/100 0755 xxx xxx in file xxx.cfg
  ```

## 违规场景及处理方案建议
  1. **目录位置违规**：在`/data`目录下但不在`/data/service`、`/data/app`或`/data/chipset`目录下创建目录
     - 处理方案：将目录创建位置调整到允许的目录下作为子目录，或将完整路径（或前缀路径）添加到白名单

  2. **路径包含特定名称目录（未在白名单中）**：路径中包含目录名称为"100"、"101"、"102"、"103"、"104"或"105"的目录，但该数字目录的完整路径未在白名单中
     - 处理方案：
       - 修改目录名称，避免使用这些特定名称
       - 或将完整的数字目录路径（截止到该数字目录）添加到白名单中

  3. **白名单匹配不当**：
     - **场景**：白名单仅包含父目录，但子目录包含100-105数字目录（如白名单包含"/data/abc"，但路径是"/data/abc/100"）
     - **处理方案**：将完整的数字目录路径（如"/data/abc/100"）添加到白名单中

  4. **权限设置不正确**：目录权限设置不符合安全要求
     - 处理方案：确保权限设置合理（如0755），但不再要求用户信息与服务UID匹配

  5. **多层数字目录**：路径中包含多个100-105数字目录（如"/data/abc/100/101"）
     - 处理方案：确保每个数字目录的完整路径都在白名单中（如"/data/abc/100"和"/data/abc/100/101"都需要在白名单中）

根据 **[规则解释](README.md#规则解释)** 排查修改，对上述规则存在疑问，找init或者存储责任田确认。